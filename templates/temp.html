<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview</title>
    <style>
        :root {
            --primary: #3498db;         /* Trustworthy blue */
            --secondary: #00bcd4;       /* Futuristic cyan */
            --dark: #2c3e50;            /* Deep space blue */
            --light: #ecf0f1;           /* Clean lab white */
            --accent: #7986cb;          /* Scientific purple */
            --background: #f5f7fa;      /* Sterile background */
            --glow-color1: rgba(52, 152, 219, 0.7);  /* Primary glow */
            --glow-color2: rgba(0, 188, 212, 0.3);   /* Secondary glow */
            --glow-accent: rgba(121, 134, 203, 0.5); /* Accent glow */
            --glow-intensity: 0.5;
            --glow-size: 15px;
            --glow-spread: 25px;        /* Increased spread for more dramatic effect */
            --glow-transition: 0.3s;     /* Smoother transitions */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233498db' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E"), linear-gradient(135deg, var(--background) 0%, #e2ebf0 100%);
            color: var(--dark);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            color: var(--primary);
            text-align: center;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 1px;
            margin-bottom: 30px;
        }

        #question {
            background-color: white;
            padding: 25px;
            border-left: 5px solid var(--primary);
            font-size: 1.2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin: 30px 0;
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;
            z-index: 1;
        }
        
        /* Enhanced sound reactive glow */
        #question.speaking {
            box-shadow: 0 0 var(--glow-size) calc(var(--glow-size) * 0.6) var(--glow-color1),
                       0 0 var(--glow-spread) calc(var(--glow-spread) * 0.8) var(--glow-color2),
                       0 0 calc(var(--glow-spread) * 2) calc(var(--glow-spread) * 1.2) var(--glow-accent);
            transform: scale(1.02) translateZ(0);
            transition: box-shadow var(--glow-transition), transform var(--glow-transition);
        }
        
        #question::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 15px;
            box-shadow: none;
            transition: box-shadow 0.4s ease;
            z-index: -1;
            pointer-events: none;
        }
        
        #question.speaking::after {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 var(--glow-size) var(--glow-color1);
            }
            50% {
                box-shadow: 0 0 var(--glow-spread) var(--glow-color2);
            }
            100% {
                box-shadow: 0 0 var(--glow-size) var(--glow-color1);
            }
        }
        
        .sound-wave {
            display: none;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 40px;
            width: 50px;
        }
        
        #question.speaking .sound-wave {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sound-wave span {
            display: inline-block;
            width: 6px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 3px;
            transition: height 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(52, 152, 219, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #start-btn {
            background: linear-gradient(45deg, var(--primary), #2980b9);
            font-size: 1.2rem;
            padding: 15px 30px;
            display: block;
            margin: 40px auto;
            width: 200px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            border-radius: 10px;
            border: 2px solid #ddd;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            resize: vertical;
            transition: border 0.3s ease;
            font-family: inherit;
        }
        
        textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        #score {
            font-size: 2rem;
            text-align: center;
            font-weight: bold;
            display: none;
            color: var(--primary);
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h3 {
            color: var(--dark);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
            display: inline-block;
        }
        
        #previous-answers {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        #previous-answers li {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        #previous-answers li:last-child {
            border-bottom: none;
        }
        
        #interview-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }
        
    #speak {
        background-color: var(--secondary);
        font-size: 1.8rem; /* Even Bigger Font */
        padding: 25px 60px; /* Wider and Taller */
        border-radius: 40px; /* Smooth Rounded Edges */
        width: 100%; /* Full Width */
        max-width: 420px; /* Bigger Max Width */
        display: block;
        margin: 20px auto;
        text-align: center;
        font-weight: bold;
        letter-spacing: 1px;
        position: relative;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 0 20px rgba(0, 188, 212, 0.7);
        overflow: hidden;
    }

    #speak.speaking {
        animation: pulseGlow 1.2s infinite ease-in-out;
    }

    @keyframes pulseGlow {
        0% {
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.8);
        }
        50% {
            box-shadow: 0 0 45px rgba(0, 188, 212, 1);
        }
        100% {
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.8);
        }
    }

    #speak::before, #speak::after {
        content: "";
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        border-radius: 40px;
        border: 6px solid transparent;
        box-sizing: border-box;
        pointer-events: none;
    }

    #speak.speaking::before {
        border-top-color: var(--primary);
        border-left-color: var(--primary);
        animation: wave1 0.8s infinite linear;
    }

    #speak.speaking::after {
        border-bottom-color: var(--accent);
        border-right-color: var(--accent);
        animation: wave2 1s infinite linear;
    }

    @keyframes wave1 {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.4);
            opacity: 0;
        }
    }

    @keyframes wave2 {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.6);
            opacity: 0;
        }
    }

            
            /* Feedback section styling */
            #feedback-container {
                margin-top: 30px;
                background: white;
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                border-left: 5px solid var(--secondary);
                transition: all 0.3s ease;
            }

            #feedback-container h3 {
                color: var(--secondary);
                border-bottom: 2px solid var(--secondary);
                padding-bottom: 10px;
                margin-top: 0;
                display: inline-block;
            }

            #feedback-button {
                background: linear-gradient(45deg, var(--secondary), #03a9f4);
                margin-top: 20px;
                margin-bottom: 15px;
                box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3);
            }

            #feedback-button:hover {
                box-shadow: 0 7px 20px rgba(0, 188, 212, 0.4);
            }

            #feedback-content {
                background: var(--background) !important;
                padding: 20px !important;
                border-radius: 10px !important;
                margin-top: 15px;
                border-left: 3px solid var(--secondary);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                max-height: 300px;
                overflow-y: auto;
                position: relative;
                transition: all 0.3s ease;
            }

            #feedback-content:empty {
                display: none;
            }

            #feedback-content::-webkit-scrollbar {
                width: 8px;
            }

            #feedback-content::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            #feedback-content::-webkit-scrollbar-thumb {
                background: var(--secondary);
                border-radius: 10px;
            }

            /* Loading animation for feedback */
            .feedback-loading {
                text-align: center;
                padding: 20px;
            }

            .feedback-loading span {
                display: inline-block;
                width: 12px;
                height: 12px;
                background-color: var(--secondary);
                border-radius: 50%;
                margin: 0 5px;
                animation: pulse 1.5s infinite ease-in-out;
            }

            .feedback-loading span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .feedback-loading span:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes pulse {
                0%, 100% {
                    transform: scale(0.8);
                    opacity: 0.5;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 1;
                }
            }

            /* Highlight important points in feedback */
            .feedback-highlight {
                background-color: rgba(0, 188, 212, 0.1);
                border-left: 3px solid var(--secondary);
                padding: 8px 12px;
                margin: 10px 0;
                border-radius: 0 8px 8px 0;
            }

            /* Feedback sections */
            .feedback-section {
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            }

            .feedback-section:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }

            .feedback-section h4 {
                color: var(--dark);
                margin-bottom: 8px;
            }
    #camera-container {
        position: fixed;
        bottom: 20px;
        right: 10px;  /* üõë Extreme right */
        width: 240px;
        height: 180px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
        display: none; /* Hidden until interview starts */
        background: black;
        border: 3px solid rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease-in-out;
    }

    #camera-container:hover {
        box-shadow: 0px 6px 14px rgba(0, 0, 0, 0.4);
        transform: scale(1.05);  /* Slight zoom effect */
    }

    #camera-feed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }

    /* Add a draggable feature */
    #camera-container:active {
        cursor: grabbing;
    }
    #countdown-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 80px;
        font-weight: bold;
        color: var(--primary);
        text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        width: 150px;
        height: 150px;
        border-radius: 50%;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
        }
        to {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
    }


    </style>
    <!-- Add this in <head> -->
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
      
</head>
<body>
    <h1>Professional Interview Coach is this </h1>

    <button id="start-btn" onclick="startInterview()">üé§ Start Interview</button>
    <!-- Countdown Animation -->
    <div id="countdown-container" style="display: none;">
        <div id="countdown">5</div>
    </div>

    <div id="interview-container" style="display: none;">
        <p id="question">Click "Start Interview" to begin.
            <div class="sound-wave">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </p>
        <!-- <textarea id="response" rows="4" placeholder="Type your response here..."></textarea> -->
        
        <textarea id="response" rows="4" placeholder="Your speech will appear here..."></textarea>
            
            <button id="speak">üé§ Start Voice Input</button>

        <button id="submit" onclick="submitResponse()">Submit Answer</button>
        <h3>Your Previous Answers</h3>
        <ul id="previous-answers"></ul>
        <div id="interview-results" style="display: none;">
            <h2>Interview Completed!</h2>
            <p><strong>Your Score:</strong> <span id="final-score"></span>/10</p>
            <p><strong>Your Resume Score:</strong> <span id="resume-score"></span>/10</p>
            <p><strong>Your overall Score:</strong> <span id="overall_score"></span>/10</p>
        </div>        
        <div id="feedback-container">
            <h3>AI Feedback</h3>
            <button id="feedback-button" onclick="fetchFeedback()">üìù Get Detailed Feedback</button>
            <div id="feedback-content"></div>
        </div>
        <!-- Camera Feed (New) -->
        
        <button onclick="window.location.href='/logout'">Logout</button>
        <canvas id="frame-canvas" style="display:none;"></canvas>
        <p id="movement-info" style="font-weight:bold; color: teal;"></p>
    </div>
    <div id="camera-container">
        <video id="camera-feed" autoplay muted playsinline></video>
        
        <div id="look-straight-warning" style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            display: none;
            border-bottom: 2px solid white;
            z-index: 99;
            font-size: 16px;
        ">‚ö†Ô∏è Please look straight at the screen</div>
    </div>
    <script>
        const videoElement = document.getElementById("camera-feed");
        const canvasElement = document.createElement("canvas");
        const ctx = canvasElement.getContext("2d");
      
        const movementInfo = document.getElementById("movement-info");
        let prevNoseY = null;
      
        function getMovement(landmarks) {
          const leftEye = landmarks[33];
          const rightEye = landmarks[263];
          const nose = landmarks[1];
      
          const dx = rightEye.x - leftEye.x;
          const dy = rightEye.y - leftEye.y;
          const tiltAngle = Math.atan2(dy, dx) * (180 / Math.PI);
      
          let movement = "Straight";
          if (tiltAngle > 5) movement = "Tilted Right";
          else if (tiltAngle < -5) movement = "Tilted Left";
      
          const eyeCenterY = (leftEye.y + rightEye.y) / 2;
          const nodAngle = (nose.y - eyeCenterY) * 100;
          let nod = "Straight";
      
          if (prevNoseY !== null) {
            const diffY = nose.y - prevNoseY;
            if (diffY > 0.015) nod = "Nodding Down";
            else if (diffY < -0.015) nod = "Nodding Up";
          }
      
          prevNoseY = nose.y;
      
          movementInfo.innerText = `${movement} | ${nod} | Tilt: ${tiltAngle.toFixed(2)}¬∞ | Nod: ${nodAngle.toFixed(2)}¬∞`;
      
          // Show ‚ÄúLook Straight‚Äù message if tilted or nodding
          if (movement !== "Straight" || nod !== "Straight") {
            showLookStraightMessage();
          } else {
            hideLookStraightMessage();
          }
        }
      
        function showLookStraightMessage() {
          if (!document.getElementById("look-straight-msg")) {
            const msg = document.createElement("div");
            msg.id = "look-straight-msg";
            msg.innerText = "üëÅÔ∏è Please look straight at the screen";
            msg.style.position = "fixed";
            msg.style.bottom = "210px";
            msg.style.right = "10px";
            msg.style.background = "#fff";
            msg.style.color = "red";
            msg.style.padding = "8px 12px";
            msg.style.borderRadius = "10px";
            msg.style.fontWeight = "bold";
            msg.style.boxShadow = "0px 2px 10px rgba(0,0,0,0.2)";
            document.body.appendChild(msg);
          }
        }
      
        function hideLookStraightMessage() {
          const msg = document.getElementById("look-straight-msg");
          if (msg) msg.remove();
        }
      
        const faceMesh = new FaceMesh({
          locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });
      
        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
      
        faceMesh.onResults(results => {
          if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];
            getMovement(landmarks);
          }
        });
      
        const camera = new Camera(videoElement, {
          onFrame: async () => {
            await faceMesh.send({ image: videoElement });
          },
          width: 640,
          height: 480
        });
      
        camera.start();
    </script>
          
    

    
<script>
        // Create a simple audio analyzer for visualization
        let audioContext = null;
        let analyzer = null;
        let currentAudio = null;
        let animationFrame = null;
        let dataHistory = []; // Store previous audio data for smoothing
        let recognition;
let isRecognizing = false;
let microphone;
let dataArray;

function startLiveSpeechToText() {
    // Check if the browser supports Web Speech API
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("Your browser does not support real-time Speech Recognition.");
        return;
    }

    // Initialize speech recognition
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;  // Keep recognizing speech
    recognition.interimResults = true;  // Show words as they are spoken
    recognition.lang = "en-US";  // Set language (Change for other languages)

    recognition.onstart = function () {
        isRecognizing = true;
        document.getElementById("speak").innerText = "üéôÔ∏è stop speaking";
        document.getElementById("speak").style.backgroundColor = "#3c58e7";
        document.getElementById("speak").classList.add("speaking"); // Change button color
        // Start voice intensity monitoring
        startVoiceMonitoring();
    };

    recognition.onresult = function (event) {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;  // Get spoken text
        }
        document.getElementById("response").value = transcript;  // Display text in textarea
    };

    recognition.onerror = function (event) {
        console.error("Speech recognition error:", event.error);
        document.getElementById("response").placeholder = "‚ùå Error recognizing speech.";
    };

    recognition.onend = function () {
        isRecognizing = false;
        document.getElementById("speak").innerText = "üé§ Start Voice Input";
        document.getElementById("speak").style.backgroundColor = "#3c58e7";
        document.getElementById("speak").classList.remove("speaking"); // Reset button color
        // Stop monitoring voice intensity
        stopVoiceMonitoring();
    };

    recognition.start();
}
// Voice volume monitoring using Web Audio API
async function startVoiceMonitoring() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        microphone = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;

        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        microphone.connect(analyser);
        monitorVolume();
    } catch (error) {
        console.error("Error accessing microphone:", error);
    }
}

function monitorVolume() {
    analyser.getByteFrequencyData(dataArray);
    let sum = 0;

    for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
    }

    let average = sum / dataArray.length;
    let intensity = Math.min(1, average / 80); // More sensitive to voice

    updateGlowEffect(intensity);

    requestAnimationFrame(monitorVolume);
}

function updateGlowEffect(intensity) {
    const speakButton = document.getElementById("speak");
    const glowSize = Math.floor(intensity * 50) + 20; // More glow
    const opacity = 0.5 + intensity * 0.5; // Brighter glow

    speakButton.style.boxShadow = `0 0 ${glowSize}px rgba(0, 188, 212, ${opacity})`;
    speakButton.style.transform = `scale(${1 + intensity * 0.15})`;
}

function stopVoiceMonitoring() {
    if (audioContext) {
        audioContext.close();
        audioContext = null;
    }
}

function stopLiveSpeechToText() {
    if (recognition && isRecognizing) {
        recognition.stop();
    }
}

// Attach function to the button
document.getElementById("speak").addEventListener("click", function () {
    if (isRecognizing) {
        stopLiveSpeechToText();
    } else {
        startLiveSpeechToText();
    }
});


        function setupAudioContext() {
            // Create audio context only once
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyzer = audioContext.createAnalyser();
                    analyzer.fftSize = 128; // Increased for better frequency resolution
                    
                    // Initialize data history
                    const bufferLength = analyzer.frequencyBinCount;
                    for (let i = 0; i < 5; i++) { // Keep 5 previous frames for smoothing
                        dataHistory.push(new Uint8Array(bufferLength).fill(0));
                    }
                } catch (e) {
                    console.error("Web Audio API not supported:", e);
                }
            }
        }
        
        function visualizeAudio() {
            if (!analyzer) return;
            
            const bufferLength = analyzer.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyzer.getByteFrequencyData(dataArray);
            
            // Add current data to history and remove oldest
            dataHistory.push(dataArray);
            if (dataHistory.length > 5) {
                dataHistory.shift();
            }
            
            // Create smoothed data by averaging the history
            const smoothedData = new Uint8Array(bufferLength);
            for (let i = 0; i < bufferLength; i++) {
                let sum = 0;
                for (let j = 0; j < dataHistory.length; j++) {
                    sum += dataHistory[j][i] || 0;
                }
                smoothedData[i] = sum / dataHistory.length;
            }
            
            // Focus on frequency range most relevant to speech (roughly 85-255Hz)
            const startBin = Math.floor(85 / (audioContext.sampleRate / analyzer.fftSize));
            const endBin = Math.floor(255 / (audioContext.sampleRate / analyzer.fftSize));
            
            // Calculate average intensity in the speech range
            let sum = 0;
            let count = 0;
            for (let i = startBin; i <= endBin && i < bufferLength; i++) {
                sum += smoothedData[i];
                count++;
            }
            
            // Calculate average with emphasis on speech frequencies
            const speechAverage = count > 0 ? sum / count : 0;
            
            // Get overall average too for broader response
            const overallAverage = smoothedData.reduce((a, b) => a + b, 0) / bufferLength;
            
            // Weighted average favoring speech frequencies
            const weightedAverage = (speechAverage * 0.7) + (overallAverage * 0.3);
            
            // Scale intensity (0-255) to usable range with enhanced sensitivity
            const baseIntensity = Math.min(1, weightedAverage / 90); // Lower threshold for more sensitivity
            
            // Apply easing function for smoother transitions
            const easedIntensity = easeInOutCubic(baseIntensity);
            
            // Dynamic properties based on intensity
            const questionElement = document.getElementById("question");
            
            // Enhanced multi-layer glow effect
            const primaryColor = `rgba(52, 152, 219, ${0.4 + easedIntensity * 0.6})`;
            const secondaryColor = `rgba(0, 188, 212, ${0.3 + easedIntensity * 0.5})`;
            const accentColor = `rgba(121, 134, 203, ${0.2 + easedIntensity * 0.3})`;
            
            // Dynamic glow sizes
            const baseSize = 15;
            const maxSize = 50; 
            const glowSize = baseSize + easedIntensity * (maxSize - baseSize);
            
            // Create a multi-layered box shadow with improved parameters
            questionElement.style.boxShadow = `
                0 0 ${glowSize/2}px ${glowSize/3}px ${primaryColor},
                0 0 ${glowSize}px ${glowSize/1.5}px ${secondaryColor},
                0 0 ${glowSize*2}px ${glowSize}px ${accentColor}
            `;
            
            // Add dynamic scaling effect
            const minScale = 1.0;
            const maxScale = 1.03;
            const scaleAmount = minScale + (easedIntensity * (maxScale - minScale));
            questionElement.style.transform = `scale(${scaleAmount})`;
            
            // Update sound wave visualization with improved dynamics
            const bars = document.querySelectorAll('.sound-wave span');
            const barCount = bars.length;
            
            for (let i = 0; i < barCount; i++) {
                // Use specific frequency bands for each bar with focus on speech frequencies
                const range = bufferLength / barCount;
                const startIndex = Math.floor(i * range);
                const endIndex = Math.floor((i + 1) * range - 1);
                
                // Get average value for this frequency range
                let barSum = 0;
                for (let j = startIndex; j <= endIndex; j++) {
                    barSum += smoothedData[j];
                }
                const barAvg = barSum / range;
                
                // Scale bar height with improved dynamics
                const minHeight = 5;
                const maxHeight = 45;
                
                // Add randomness for more natural movement
                const randomFactor = 1 + (Math.random() * 0.2 - 0.1); // ¬±10% variation
                
                const barIntensity = (barAvg / 255) * randomFactor;
                const height = minHeight + easeOutBack(barIntensity) * (maxHeight - minHeight);
                
                // Apply height with custom easing for more natural movement
                bars[i].style.height = `${height}px`;
            }
            
            // Continue animation loop
            if (!currentAudio.paused) {
                animationFrame = requestAnimationFrame(visualizeAudio);
            } else {
                // Stop visualization when audio ends
                stopVisualization();
            }
        }
        
        // Easing functions for smoother animations
        function easeInOutCubic(x) {
            return x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2;
        }
        
        function easeOutBack(x) {
            const c1 = 1.70158;
            const c3 = c1 + 1;
            return 1 + c3 * Math.pow(x - 1, 3) + c1 * Math.pow(x - 1, 2);
        }
        
        function stopVisualization() {
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            // Reset visual effects with gentle transition
            const questionElement = document.getElementById("question");
            questionElement.classList.remove("speaking");
            questionElement.style.boxShadow = "";
            questionElement.style.transform = ""; 
            
            // Reset sound wave bars
            const bars = document.querySelectorAll('.sound-wave span');
            bars.forEach(bar => {
                bar.style.height = "8px";
            });
            
            // Clear data history
            dataHistory = [];
        }
        
async function startInterview() {
    document.getElementById("start-btn").style.display = "none";

    // Show countdown before starting the interview
    document.getElementById("countdown-container").style.display = "flex";

    let countdown = 5;
    document.getElementById("countdown").innerText = countdown;

    let countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            document.getElementById("countdown").innerText = countdown;
        } else {
            clearInterval(countdownInterval);
            document.getElementById("countdown-container").style.display = "none"; // Hide countdown
            
            // Start Camera
            startCamera().then(() => {
                beginInterview(); // Begin interview only after camera starts
            });
        }
    }, 1000);
}

async function beginInterview() {
    // Set up audio context for visualization
    setupAudioContext();

    const response = await fetch("/start_interview");
    const data = await response.json();

    document.getElementById("question").innerText = data.question;
    document.getElementById("interview-container").style.display = "block";

    // Create sound wave elements
    const soundWave = document.createElement('div');
    soundWave.className = 'sound-wave';
    for (let i = 0; i < 5; i++) {
        const bar = document.createElement('span');
        soundWave.appendChild(bar);
    }
    document.getElementById("question").appendChild(soundWave);

    // Speak question after camera starts
    speakText(data.question);
}


        let mediaRecorder;
let recordedChunks = [];

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });

        const videoElement = document.getElementById("camera-feed");
        videoElement.srcObject = stream;
        videoElement.play();

        document.getElementById("camera-container").style.display = "block";

        // Start recording video
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => recordedChunks.push(event.data);
        mediaRecorder.start();

    } catch (error) {
        console.error("Camera access denied:", error);
        alert("‚ö†Ô∏è Camera permission is required for the interview.");
    }
}

function stopRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, { type: "video/webm" });
            const formData = new FormData();
            formData.append("video", blob, "interview_recording.webm");

            try {
                const response = await fetch("/upload_video", {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    console.log("‚úÖ Video uploaded successfully:", result.video_url);
                } else {
                    console.error("‚ùå Video upload failed.");
                }
            } catch (error) {
                console.error("‚ùå Error uploading video:", error);
            }
        };
    }
}



        async function getQuestion() {
            const response = await fetch("/get_question");
            const data = await response.json();

            if (data.message === "Interview Completed!") {
                document.getElementById("question").innerText = "üéâ " + data.message;
                document.getElementById("final-score").innerText = data.score; // Interview Score
                document.getElementById("resume-score").innerText = data.resume_score; // Resume Score
                document.getElementById("overall_score").innerText = data.overall_score; // overall Score
                document.getElementById("interview-results").style.display = "block"; // Show result

                // Stop Video Recording
                stopRecording();

                // Disable input fields after interview
                document.getElementById("response").disabled = true;
                document.getElementById("submit").disabled = true;
                document.getElementById("speak").disabled = true;
            } else {
                document.getElementById("question").innerText = data.question;
            
                // Recreate sound wave elements to avoid text issues
                let soundWave = document.querySelector('.sound-wave');
                if (!soundWave) {
                    soundWave = document.createElement('div');
                    soundWave.className = 'sound-wave';
                    for (let i = 0; i < 5; i++) {
                        const bar = document.createElement('span');
                        soundWave.appendChild(bar);
                    }
                    document.getElementById("question").appendChild(soundWave);
                }

                speakText(data.question);
            }
        }


        async function submitResponse() {
            let userResponse = document.getElementById("response").value.trim();
            if (!userResponse) return;

            document.getElementById("submit").disabled = true;

            await fetch("/submit_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ response: userResponse })
            });

            document.getElementById("previous-answers").innerHTML += `<li>${userResponse}</li>`;
            document.getElementById("response").value = "";

            await getQuestion();
            document.getElementById("submit").disabled = false;
        }

        async function speakText(text) {
    try {
        console.log("üîä Requesting TTS for:", text);

        // Disable Speak Button While AI is Speaking
        const speakButton = document.getElementById("speak");

        if (isRecognizing) {
            stopLiveSpeechToText();
        }

        speakButton.disabled = true;
        speakButton.style.opacity = "0.5"; // Make it look disabled
        speakButton.innerText = "‚è≥ AI Speaking..."; // Show loading text

        // Request TTS from Flask
        const response = await fetch("/text_to_speech", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text })
        });

        const result = await response.json();

        if (result.audio_url) {
            console.log("‚úÖ Received audio URL:", result.audio_url);

            // Add timestamp to force fetching the latest version
            const audioSrc = result.audio_url + "?t=" + new Date().getTime();

            // Stop any previously playing audio
            if (window.currentAudio) {
                window.currentAudio.pause();
                stopVisualization();
            }

            // Create a new audio element
            const audio = new Audio(audioSrc);
            window.currentAudio = audio;
            currentAudio = audio;

            // Set up audio for visualization
            if (audioContext && analyzer) {
                const source = audioContext.createMediaElementSource(audio);
                source.connect(analyzer);
                analyzer.connect(audioContext.destination);
            }

            // Play the audio and log success/failure
            audio.play().then(() => {
                console.log("üéµ Playing audio...");
                document.getElementById("question").classList.add("speaking");

                // Start visualization
                if (analyzer) {
                    animationFrame = requestAnimationFrame(visualizeAudio);
                }
            }).catch(error => {
                console.error("‚ùå Audio play error:", error);
            });

            // Remove speaking effect and enable button when audio ends
            audio.onended = () => {
                stopVisualization();
                console.log("üîá Audio finished playing.");

                // Re-enable Speak Button After AI Finishes
                speakButton.disabled = false;
                speakButton.style.opacity = "1"; // Reset appearance
                speakButton.innerText = "üé§ Start Voice Input"; // Restore button text
            };

        } else {
            console.error("‚ùå TTS Error:", result.error);

            // Ensure Speak Button Re-Enables on Error
            speakButton.disabled = false;
            speakButton.style.opacity = "1";
            speakButton.innerText = "üé§ Start Voice Input"; // Restore text
        }
    } catch (error) {
        console.error("‚ùå Error in TTS request:", error);

        // Ensure Speak Button Re-Enables on Error
        const speakButton = document.getElementById("speak");
        speakButton.disabled = false;
        speakButton.style.opacity = "1";
        speakButton.innerText = "üé§ Start Voice Input";
    }
}

        // async function recognizeSpeech() {
        //     const response = await fetch("/speech_to_text", { method: "POST" });
        //     const data = await response.json();

        //     if (data.text && data.text !== "No speech recognized.") {
        //         document.getElementById("response").value = data.text;
        //     } else {
        //         document.getElementById("response").placeholder = "Try speaking again...";
        //     }
        // }
        
        async function fetchFeedback() {
            const feedbackContent = document.getElementById("feedback-content");
            
            // Show loading animation
            feedbackContent.innerHTML = `
                <div class="feedback-loading">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>`;
            
            try {
                const response = await fetch("/get_feedback");
                const data = await response.json();

                if (data.feedback) {
                    // Process feedback to add structure and highlights
                    let processedFeedback = processFeedback(data.feedback);
                    feedbackContent.innerHTML = processedFeedback;
                } else {
                    feedbackContent.innerHTML = `
                        <div class="feedback-section">
                            <h4>‚ö†Ô∏è No feedback available</h4>
                            <p>Please submit at least one answer to receive feedback.</p>
                        </div>`;
                }
            } catch (error) {
                feedbackContent.innerHTML = `
                    <div class="feedback-section">
                        <h4>‚ùå Error retrieving feedback</h4>
                        <p>Please try again later.</p>
                    </div>`;
            }
        }

        // Function to process feedback text and add structure

        function processFeedback(feedbackText) {
            // Split feedback into sections (this is a simplified example)
            // In a real implementation, you might want to parse specific sections from the AI response
            
            let sections = feedbackText.split('\n\n');
            let result = '';
            
            sections.forEach((section, index) => {
                // Highlight key points (e.g., lines starting with specific phrases)
                if (section.includes("Strengths:") || section.includes("Improvements:") || 
                    section.includes("Key points:") || section.includes("Summary:")) {
                    
                    let title = section.split(':')[0];
                    let content = section.substring(section.indexOf(':') + 1);
                    
                    result += `<div class="feedback-section">
                        <h4>${title}:</h4>
                        <div class="feedback-highlight">${content}</div>
                    </div>`;
                } else {
                    result += `<div class="feedback-section">${section}</div>`;
                }
            });
            
            return result;
        }
    </script>
</body>
</html>